<!doctype html>
<html lang="en">
  <head>
    <title>OpenSpace :: World View</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
      body {
        font-family: Monospace;
        background-color: #000000;
        margin: 0px;
        overflow: hidden;
      }
      
    </style>
    <link rel="stylesheet" type="text/css" href="hud.css"></link>

  </head>
  <body>
    <script src="js/Three.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/RequestAnimationFrame.js"></script>
    <script src="js/Stats.js"></script>
    <script src="js/Ship.js"></script>  
    <script src="js/Hud.js"></script>       
    <script src="js/CameraView.js"></script> 
    <script>
// variables
      var shipID, torpID;
      var myTorpedoes = {};
      var ships = {};
      var torpedoes = {};
      var world;
      var newWorldFlag = false;    
      var msg, latest, world;
      var socket;
      var container, stats;
        
      var scene = new THREE.Scene();
      var camera, renderer, objects, sphereMesh;
      var camView = new CameraViewController();
      var particleLight, pointLight;
      var station, skin;
      
      var hud = new Hud(); 
      var jLoader = new THREE.JSONLoader(true);      

// functions
      function updatePosition(worldSignal) {
          for(var i=0;i<world.ships.length;i++){
            var m = world.ships[i];
            ships[m.id].position = m.position;
            ships[m.id].velocity = m.velocity;
            ships[m.id].angularVelocity = m.angularVelocity;
            ships[m.id].mesh.quaternion.set(
              m.quaternion.x, m.quaternion.y, m.quaternion.z, m.quaternion.w
            ); 
          };
          for(var i=0;i<world.torpedoes.length;i++){
            var torp = world.torpedoes[i];
            torpedoes[torp.id].position = torp.position;
            torpedoes[torp.id].velocity = torp.velocity;
            torpedoes[torp.id].angularVelocity = torp.angularVelocity;
            torpedoes[torp.id].mesh.quaternion.set(
              torp.quaternion.x, torp.quaternion.y, torp.quaternion.z, torp.quaternion.w
            );
          };
      };    
  
      function loadWorld(callback){
        sphereMesh = new THREE.Mesh( 
          new THREE.SphereGeometry( 1500, 60, 40),  
          new THREE.MeshBasicMaterial( {
            map: THREE.ImageUtils.loadTexture( 'images/sun_pannel.jpg' ) } 
          )
        );
        sphereMesh.scale.x = -1;
                                if (callback !== undefined) callback();
      };
                       
      function loadBerth(callback){
        jLoader.load(
          'obj/berth.js', 
          function(geo){
            geo.materials[0].shading = THREE.FlatShading;
            var material = new THREE.MeshFaceMaterial();
            station = new THREE.Mesh(geo, material);
            station.scale.set(0.01, 0.01, 0.01);
            station.updateMatrix();
            station.castShadow = true;
            station.receiveShadow = true;
            if (callback !== undefined) callback();
          }, 
          'obj/'
         );
       };

// listeners      
       socket = io.connect('http://'+location.host);
       socket.on('openspace.loop', function(ship_signal){
          world = ship_signal;
          updatePosition(ship_signal);
       });
       socket.on('openspace.welcome',function(message){
         msg = message;
         shipID = msg.ship.id;
         // Add the Ships Mesh
         world = msg.world;
         for (var i=0;i<world.ships.length;i++){
           var s = new Ship(shipClasses.MartianDestroyer);
           s.id = world.ships[i].id;
           ships[s.id] = s;
         };
         // Add the Torpedo Meshs
         for (var i=0; i<world.torpedoes.length; i++){
           var t = new Ship(shipClasses.TorpedoMkI);
           t.id = world.torpedoes[i].id;
           torpedoes[t.id] = t;
         };
         init();
         animate();
       });
       socket.on('openspace.newShip',function(message){
         var newShip = new Ship(shipClasses.MartianDestroyer);
         newShip.id = message.shipID;
         ships[message.shipID] = newShip;
         newShip.load(function(mesh){scene.add(mesh)});
       });
       socket.on('openspace.new.torpedo',function(message){
         var t = new Ship(shipClasses.TorpedoMkI);
         t.id = message.torpedo.id;
         torpedoes[message.torpedo.id] = t;
         t.load(function(mesh){scene.add(mesh)});
       });
       socket.on('openspace.detonate.torpedo',function(message){
          var t = message.torpedo;
          // todo: something
       });

// callback chain
       loadWorld(function(){
         loadBerth(function(){
         })
       });
      
// init
// animate
// render
      function init() {
        document.onkeydown= returnKey;
        container = document.createElement( 'div' );
        document.body.appendChild( container );

        camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
        camera.position.set( 2, 2, 3 );
        scene.add(camera);
        
        
        // Sphere
        scene.add(sphereMesh);

        // Add the Station 
        scene.add( station );

        // Add the Ships
       for (var sid in ships){
         ships[sid].load(function(mesh){scene.add(mesh)});
       }; 
       
       // Add the Torpedos
       for (var tid in torpedoes){
         torpedoes[tid].load(function(mesh){scene.add(mesh)});
       };

       // Lights
       var directionalLight = new THREE.DirectionalLight(/*Math.random() * 0xffffff*/0xeeeeee );

       pointLight = new THREE.PointLight( 0xffffff, 10 );
       pointLight.position.x = -100000;
       scene.add( pointLight );

       renderer = new THREE.WebGLRenderer();
       renderer.setSize( window.innerWidth, window.innerHeight );

       container.appendChild( renderer.domElement );
      
       hud.init(container);  
     }

      //

      var t = 0;
      function animate() {

        requestAnimationFrame( animate );
        if ( t > 30 ) t = 0;
        
        for (var shipID in ships) ships[shipID].animate();
        for (var tID in torpedoes) torpedoes[tID].animate();
                          
        render();
        hud.animate();
      }

      function render() {
        var p = ships[shipID].position;
        camView.setCamera();
        sphereMesh.position = p;
        renderer.render( scene, camera );      
      }
      
      function quaterionFromYawPitchRoll(yaw, pitch, roll){
        var q = new THREE.Quaternion();
        var n1, n2, n3, n4, n5, n6, n7, n8, n9;
        n9 = roll * 0.5;
        n6 = Math.sin(n9);
        n5 = Math.cos(n9);
        n8 = pitch * 0.5;
        n4 = Math.sin(n8);
        n3 = Math.cos(n8);
        n7 = yaw * 0.5;
        n2 = Math.sin(n7);
        n1 = Math.cos(n7);
        q.x = ((n1 * n4) * n5) + ((n2 * n3) * n6);
        q.y = ((n2 * n3) * n5) - ((n1 * n4) * n6);
        q.z = ((n1 * n3) * n6) - ((n2 * n4) * n5);
        q.w = ((n1 * n3) * n5)  + ((n2 * n4) * n6);
        
        return q;
      
      }
          
      function detonate(e){
        socket.emit('torpedo.detonate', {torpedoId: e});
        alert('detonation sent');
      }
    
      function returnKey(evt) {
        var evt  = (evt) ? evt : ((event) ? event : null);
        switch(evt.keyCode){
        
          case 49: // 1
            camView.setView(1);
            break;
          case 50: // 2
            camView.setView(2);
            break;
          case 51: // 3
            camView.setView(3);
            break;
          case 52: // 4
            camView.setView(4);
            break;
          case 53: // 5
            camView.setView(5);
            break;
          case 54: // 6
            camView.setView(6);
            break;
          case 55: // 7 
            camView.setView(7);
            break;
          case 56: // 8
            break;
          case 57: // 9
            break;
          case 48: // 0
            camView.setView(0);
            break;
          case 84: // fire torpedoes
            socket.emit('torpedo.fire', {shipId: shipID}, function(newTorp){
              var t = new Ship(shipClasses.TorpedoMkI);
              t.id = newTorp.id;
              torpedoes[t.id] = t;
              t.load(function(mesh){scene.add(mesh)});
              myTorpedoes[t.id] = {target:hud.WPN.targetObject};
            });
            break;
      
          case 32: // space bar, thruster
            socket.emit('ship.drive', {shipId: shipID});
            break;
            
          case 38: // up arrow, nose up
            socket.emit('ship.thrust', {type:'noseUp', shipId: shipID});
            break;
            
          case 40: // down arrow, nose down
            socket.emit('ship.thrust', {type:'noseDown', shipId: shipID});
            break;
            
          case 37: // left arrow, pivot left or roll left
            if (evt.ctrlKey){
                                                  socket.emit('ship.thrust', {type:'pivotLeft', shipId: shipID});
            } else {
                    socket.emit('ship.thrust', {type:'rollLeft', shipId: shipID});
            };
            break;
            
          case 39: // right arrow, pivot right or roll right
            if (evt.ctrlKey){
              socket.emit('ship.thrust', {type:'pivotRight', shipId: shipID});
            } else {
              socket.emit('ship.thrust', {type:'rollRight', shipId: shipID});
            };
            break;
          case 82: // r ~ Reset in dev mode
              socket.emit('ship.devReset', {shipId:shipID});
            break;            
          case 68: // d, detonate
              socket.emit('torpedo.detonate', {torpedoId: torpID});
            break;
          default:
            break;
        }
      }

    </script>
  </body>
</html>
